% TODO: Those rules can't really be used for typechecking because of the unary
% records.
% They should either be rewritten with n-ary records or we should accept a
% dummy top-down typing for records.
\begin{figure}
  \newcommand{\onerec}{\{..\}}
  \begin{mathpar}
    \inferrule{%
      \forall i \in I, Γ \tinfer e_i : s_i \\
      \forall i \in I, Γ \tIC e'_i : τ_i \\
      \forall (i, i') \in I^2, i \neq i' \Rightarrow s_i \neq s_{i'}
    }{%
      Γ \tIC \left\{ \seq{e_i = e'_i;}{i\in I} \right\} :
        \left\{ s_i = τ_i \right\}
    }\lbl{RFinite}

    \and\inferrule{%
      \forall i \in I, Γ \tinfer e_i : τ_i \\
      \forall i \in I, Γ \tinfer e'_i : σ_i \\
      \forall i \in I, τ_i \subtype \text{String}
    }{%
      Γ \tinfer \left\{ \seq{e_i = e'_i;}{i \in I} \right\} :
    \left\{ \_ = \left(\bigvee\limits_{i \in I} σ_i \right) \vee \undefr \right\}
    }\lbl{IRInfinite}

    \and\inferrule{%
      \forall i \in I, Γ \tinfer e_i : τ_i \\
      \forall i \in I, Γ \tcheck e'_i : σ \\
      \forall i \in I, τ_i \subtype \text{String}
    }{%
      Γ \tcheck \left\{ \seq{e_i = e'_i;}{i \in I} \right\} :
    \left\{ \_ = σ \vee \undefr \right\}
    }\lbl{CRInfinite}

    \and\inferrule{%
      Γ \tinfer e_1 : \tau \\ Γ \tinfer e_2 : σ \\
    \tau \subtype \onerec{} \\
    σ \subtype \onerec{}
    }{%
      Γ \tIC e_1 + e_2 : \tau + σ
    }\lbl{RMerge}

    \and\inferrule{%
      Γ \tinfer e_1 : τ \\
      Γ \tinfer e_2 : s \\
      τ \subtypeG \onerec \\
      τ(s) \wedge \undefr \subtype \Empty
    }{%
      Γ \tIC e_1 . e_2 : τ(s)
    }\lbl{RAccessFinite}

    \and\inferrule{%
      Γ \vdash e_1 : τ \\
      Γ \vdash e_2 : s \\
      Γ \vdash e_3 : σ
    }{%
      Γ \vdash e_1 . e_2 \text{ or } e_3 :
      \left( τ(s) \backslash \undefr \right) \vee σ
    }\lbl{RGuardedAccessFinite}

    \and\inferrule{%
      Γ \vdash e_1 : τ \\ Γ \vdash e_2 : τ' \\
      τ' \subtype \text{string} \\
      Γ \vdash e_3 : σ
    }{%
      Γ \vdash e_1 . e_2 \text{ or } e_3 :
      \left( \defr(τ) \vee
        \bigvee\limits_{s \in \dom(τ)} τ(s) \backslash \undefr \right)
        \vee σ
    }\lbl{RGuardedAccessInfinite}
  \end{mathpar}
  \caption{Typing rules for records\label{typing::records}}
\end{figure}
